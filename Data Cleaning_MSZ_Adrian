/*The output of this query is used by our data managers during the data cleaning phase.
Their wish was to have all DCRs, warnings, informs, notes and missings in one single list.
Depending on the size of the study, this query may need several hours to run.*/

(select t.CLINICALTRIALNAME as STUDY, r.MIMESSAGESITE as CENTER, s.LOCALIDENTIFIER1 as SUBJECT, 
v.VISITNAME as VISIT, v.VISITORDER, r.MIMESSAGEVISITCYCLE as VISIT_NR, c.CRFTITLE as FORM, 
r.MIMESSAGECRFPAGECYCLE as FORM_NR, i.DATAITEMNAME as ITEM, 
'Note' AS Status,
r.MIMESSAGERESPONSEVALUE as VALUE, r.MIMESSAGERESPONSECYCLE as REPEAT_NR, r.MIMESSAGETEXT as MESSAGE, (CONVERT(datetime,r.MIMESSAGECREATED)-2)  as DATE, r.MIMESSAGEUSERNAME as USERID
from MIMESSAGE as r
join CLINICALTRIAL as t on r.MIMESSAGETRIALNAME = t.CLINICALTRIALNAME
join TRIALSUBJECT as s on t.CLINICALTRIALID = s.CLINICALTRIALID and r.MIMESSAGESITE = s.TRIALSITE and r.MIMESSAGEPERSONID = s.PERSONID
join STUDYVISIT as v on t.CLINICALTRIALID = v.CLINICALTRIALID and r.MIMESSAGEVISITID = v.VISITID
join CRFPAGE as c on t.CLINICALTRIALID = c.CLINICALTRIALID and r.MIMESSAGECRFPAGEID = c.CRFPAGEID
join DATAITEM as i on t.CLINICALTRIALID = i.CLINICALTRIALID and r.MIMESSAGEDATAITEMID = i.DATAITEMID
where r.MIMESSAGETYPE = 2)

UNION ALL

(select t.CLINICALTRIALNAME as STUDY, r.MIMESSAGESITE as CENTER, s.LOCALIDENTIFIER1 as SUBJECT, 
v.VISITNAME as VISIT, v.VISITORDER, r.MIMESSAGEVISITCYCLE as VISIT_NR, c.CRFTITLE as FORM, 
r.MIMESSAGECRFPAGECYCLE as FORM_NR, i.DATAITEMNAME as ITEM,
CASE 
WHEN r.MIMESSAGESTATUS = 0 THEN 'DCR_Raised'
WHEN r.MIMESSAGESTATUS = 1 THEN 'DCR_Responded'
WHEN r.MIMESSAGESTATUS = 2 THEN 'DCR_Closed'
ELSE 'ERROR'
END as Status, 
r.MIMESSAGERESPONSEVALUE as VALUE, r.MIMESSAGERESPONSECYCLE as REPEAT_NR, r.MIMESSAGETEXT as MESSAGE, (CONVERT(datetime,r.MIMESSAGECREATED)-2)  as DATE, r.MIMESSAGEUSERNAME as USERID
from MIMESSAGE as r
join CLINICALTRIAL as t on r.MIMESSAGETRIALNAME = t.CLINICALTRIALNAME
join TRIALSUBJECT as s on t.CLINICALTRIALID = s.CLINICALTRIALID and r.MIMESSAGESITE = s.TRIALSITE and r.MIMESSAGEPERSONID = s.PERSONID
join STUDYVISIT as v on t.CLINICALTRIALID = v.CLINICALTRIALID and r.MIMESSAGEVISITID = v.VISITID
join CRFPAGE as c on t.CLINICALTRIALID = c.CLINICALTRIALID and r.MIMESSAGECRFPAGEID = c.CRFPAGEID
join DATAITEM as i on t.CLINICALTRIALID = i.CLINICALTRIALID and r.MIMESSAGEDATAITEMID = i.DATAITEMID
where r.MIMESSAGETYPE = 0 and r.MIMESSAGEHISTORY = 0)

UNION ALL

(select t.CLINICALTRIALNAME as STUDY, r.TRIALSITE as CENTER, s.LOCALIDENTIFIER1 as SUBJECT, 
v.VISITNAME as VISIT, v.VISITORDER, r.VISITCYCLENUMBER as VISIT_NR, c.CRFTITLE as FORM, 
r.CRFPAGECYCLENUMBER as FORM_NR, i.DATAITEMNAME as ITEM, 
CASE r.RESPONSESTATUS WHEN '10' THEN 'Missing' WHEN '20' THEN 'Inform' WHEN '30' THEN 'Warning' END AS Status,
r.RESPONSEVALUE as VALUE, r.REPEATNUMBER as REPEAT_NR, r.VALIDATIONMESSAGE as MESSAGE, (CONVERT(datetime,r.RESPONSETIMESTAMP)-2)  as DATE, r.USERNAME as USERID
from DATAITEMRESPONSE as r
join TRIALSUBJECT as s on r.CLINICALTRIALID = s.CLINICALTRIALID and r.TRIALSITE = s.TRIALSITE and r.PERSONID = s.PERSONID
join STUDYVISIT as v on r.CLINICALTRIALID = v.CLINICALTRIALID and r.VISITID = v.VISITID
join CRFPAGE as c on r.CLINICALTRIALID = c.CLINICALTRIALID and r.CRFPAGEID = c.CRFPAGEID
join DATAITEM as i on r.CLINICALTRIALID = i.CLINICALTRIALID and r.DATAITEMID = i.DATAITEMID
join CLINICALTRIAL as t on r.CLINICALTRIALID = t.CLINICALTRIALID
where r.RESPONSESTATUS = 20 or r.RESPONSESTATUS = 30 or r.RESPONSESTATUS = 10)
order by STUDY, CENTER, SUBJECT, VISITORDER, VISIT_NR, FORM, FORM_NR, ITEM
